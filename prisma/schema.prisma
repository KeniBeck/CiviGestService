// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// CiviGest - Sistema de gestión ciudadana multi-tenant
// Arquitectura simplificada: Sede (Departamento/Cliente) → Subsede (Municipio/Oficina)
// Schema optimizado para PostgreSQL con roles y permisos

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// CONFIGURACIÓN DEL MUNICIPIO (CLIENTE)
// ============================================

model Configuracion {
  id        Int @id @default(autoincrement())
  sedeId    Int // Multi-tenant: Estado
  subsedeId Int @unique // Una configuración POR municipio

  // Información del cliente
  nombreCliente String @db.VarChar(200)
  pais          String @default("México") @db.VarChar(100)
  ciudad        String @db.VarChar(100)

  // Branding
  logo    String? @db.Text // URL o base64
  slogan  String? @db.VarChar(255)
  titular String? @db.VarChar(200) // Nombre del titular/alcalde

  // Tema visual
  themeId Int? // FK a Theme

  // Valores económicos (se actualizan automáticamente)
  salarioMinimo Decimal @db.Decimal(10, 2) // Salario mínimo vigente
  uma           Decimal @db.Decimal(10, 2) // UMA vigente

  // Contacto general
  correoContacto   String? @db.VarChar(100)
  whatsappContacto String? @db.VarChar(20)
  telContacto      String? @db.VarChar(20)

  // Contacto atención ciudadana
  correoAtencion   String? @db.VarChar(100)
  whatsappAtencion String? @db.VarChar(20)
  telAtencion      String? @db.VarChar(20)

  // Configuración fiscal
  tasaRecargo Decimal @default(0) @db.Decimal(5, 2) // % SAT

  // Estado y auditoría
  isActive  Boolean   @default(true)
  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  createdBy Int?

  // Relaciones
  sede    Sede    @relation(fields: [sedeId], references: [id], onDelete: Cascade)
  subsede Subsede @relation(fields: [subsedeId], references: [id], onDelete: Cascade)
  theme   Theme?  @relation(fields: [themeId], references: [id], onDelete: SetNull)

  @@index([sedeId])
  @@index([subsedeId])
  @@index([themeId])
  @@index([isActive])
  @@index([deletedAt])
  @@map("configuraciones")
}

// ============================================
// MULTI-TENANCY Y ORGANIZACIÓN
// ============================================

// SEDE: Departamento/Cliente que contrata el servicio
// Es el nivel superior (multi-tenant), creado solo por super admins
model Sede {
  id   Int    @id @default(autoincrement())
  name String @db.VarChar(100) // Nombre del estado
  code String @unique @db.VarChar(20) // Código del estado

  // Estado y auditoría
  isActive  Boolean   @default(true)
  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  createdBy Int?

  // Relaciones
  subsedes        Subsede[]
  users           User[]
  userSedeAccess  UserSedeAccess[]
  multas          Multa[]
  departamentos   Departamento[]
  agentes         Agente[]
  patrullas       Patrulla[]
  tiposAgentes    TipoAgente[]
  configuraciones Configuracion[]
  tipoPermisos    TipoPermiso[]
  permisos        Permiso[]
  pagosPermisos   PagoPermiso[]

  @@index([code])
  @@index([isActive])
  @@index([deletedAt])
  @@map("sedes")
}

// SUBSEDE: Municipio/Oficina dentro de una Sede
model Subsede {
  id     Int    @id @default(autoincrement())
  sedeId Int
  name   String @db.VarChar(100) // Nombre del municipio
  code   String @db.VarChar(20) // Código del municipio (único dentro de la sede)

  // Estado y auditoría
  isActive  Boolean   @default(true)
  deletedAt DateTime? // Soft delete
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  createdBy Int? // ID del usuario que creó la subsede

  // Relaciones
  sede              Sede                @relation(fields: [sedeId], references: [id], onDelete: Cascade)
  users             User[]
  userSubsedeAccess UserSubsedeAccess[] // Acceso explícito de usuarios
  multas            Multa[]
  departamentos     Departamento[]
  agentes           Agente[]
  patrullas         Patrulla[]
  tiposAgentes      TipoAgente[]
  configuracion     Configuracion?
  tipoPermisos      TipoPermiso[]
  permisos          Permiso[]
  pagosPermisos     PagoPermiso[]

  @@unique([sedeId, code])
  @@index([sedeId])
  @@index([isActive])
  @@index([deletedAt])
  @@map("subsedes")
}

// ============================================
// CONTROL DE ACCESO A SEDES Y SUBSEDES
// ============================================

// Define a qué SEDES tiene acceso un usuario
// Permite que usuarios cross-sede tengan acceso a múltiples departamentos
model UserSedeAccess {
  id     Int @id @default(autoincrement())
  userId Int
  sedeId Int

  // Relaciones
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  sede Sede @relation(fields: [sedeId], references: [id], onDelete: Cascade)

  // Auditoría
  grantedAt DateTime @default(now())
  grantedBy Int // ID del usuario que otorgó el acceso
  isActive  Boolean  @default(true)

  @@unique([userId, sedeId])
  @@index([userId])
  @@index([sedeId])
  @@map("user_sede_access")
}

// Define a qué SUBSEDES tiene acceso un usuario
// Permite que usuarios municipales tengan acceso a varios municipios
model UserSubsedeAccess {
  id        Int @id @default(autoincrement())
  userId    Int
  subsedeId Int

  // Relaciones
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  subsede Subsede @relation(fields: [subsedeId], references: [id], onDelete: Cascade)

  // Auditoría
  grantedAt DateTime @default(now())
  grantedBy Int // ID del usuario que otorgó el acceso
  isActive  Boolean  @default(true)

  @@unique([userId, subsedeId])
  @@index([userId])
  @@index([subsedeId])
  @@map("user_subsede_access")
}

// ============================================
// SISTEMA DE TEMAS Y PERSONALIZACIÓN
// ============================================

model Theme {
  id          Int     @id @default(autoincrement())
  name        String  @db.VarChar(50)
  description String? @db.VarChar(255)

  // Colores principales
  primaryColor   String @db.VarChar(7)
  secondaryColor String @db.VarChar(7)
  accentColor    String @db.VarChar(7)

  // Colores de fondo
  backgroundColor String @db.VarChar(7)
  surfaceColor    String @db.VarChar(7)

  // Colores de texto
  textPrimaryColor   String @db.VarChar(7)
  textSecondaryColor String @db.VarChar(7)

  // Colores de estado
  successColor String @db.VarChar(7)
  warningColor String @db.VarChar(7)
  errorColor   String @db.VarChar(7)
  infoColor    String @db.VarChar(7)

  // Modo oscuro
  darkMode Boolean @default(false)

  // Estado
  isDefault Boolean @default(false)

  // Auditoría
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  configuraciones Configuracion[]

  @@index([isDefault])
  @@map("themes")
}

// ============================================
// MODELOS DE USUARIO Y AUTENTICACIÓN
// ============================================

model User {
  id        Int  @id @default(autoincrement())
  sedeId    Int // Multi-tenant: usuario pertenece a una Sede (departamento)
  subsedeId Int? // Subsede principal del usuario (opcional)

  email    String @unique
  username String @unique
  password String // Hash bcrypt

  // Datos personales básicos
  firstName        String  @db.VarChar(100)
  lastName         String  @db.VarChar(100)
  phoneCountryCode String  @default("+52") @db.VarChar(5)
  phoneNumber      String  @db.VarChar(20)
  address          String? @db.VarChar(255)

  // Identificación
  documentType   DocumentType @default(CURP)
  documentNumber String       @unique @db.VarChar(20)

  // Seguridad y recuperación de contraseña
  isEmailVerified      Boolean   @default(false)
  isPhoneVerified      Boolean   @default(false)
  passwordResetToken   String?   @unique @db.VarChar(255)
  passwordResetExpires DateTime?
  otpRequestCount      Int       @default(0)
  lastOtpRequestAt     DateTime?
  lastLoginAt          DateTime?

  // Control de acceso
  accessLevel AccessLevel @default(SUBSEDE) // Nivel de acceso del usuario

  // Estado y auditoría
  isActive  Boolean   @default(true)
  deletedAt DateTime? // Soft delete
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  createdBy Int? // ID del usuario que creó este usuario

  // Relaciones
  sede    Sede       @relation(fields: [sedeId], references: [id], onDelete: Cascade)
  subsede Subsede?   @relation(fields: [subsedeId], references: [id], onDelete: SetNull)
  roles   UserRole[]

  // Acceso explícito a sedes y subsedes (para usuarios cross-tenant)
  sedeAccess    UserSedeAccess[]
  subsedeAccess UserSubsedeAccess[]

  // Pagos de permisos
  pagosRealizados  PagoPermiso[] @relation("PagosRealizados")
  pagosAutorizados PagoPermiso[] @relation("PagosAutorizados")

  @@index([sedeId])
  @@index([subsedeId])
  @@index([email])
  @@index([documentNumber])
  @@index([isActive])
  @@index([deletedAt])
  @@index([accessLevel])
  @@map("users")
}

// ============================================
// MÓDULO DE MULTAS (CATÁLOGO)
// ============================================

model Multa {
  id        Int @id @default(autoincrement())
  sedeId    Int // Multi-tenant: Sede (Estado)
  subsedeId Int // Municipio que crea la multa

  // Identificación
  nombre      String  @db.VarChar(200)
  codigo      String  @db.VarChar(50) // Código único dentro del municipio
  descripcion String? @db.Text

  // Montos (usar UNO de estos métodos)
  costo       Decimal? @db.Decimal(10, 2) // Monto fijo en pesos
  numUMAs     Decimal? @db.Decimal(10, 2) // Cantidad de UMAs
  numSalarios Decimal? @db.Decimal(10, 2) // Cantidad de salarios mínimos
  recargo     Decimal? @db.Decimal(10, 2) // Recargo en pesos si aplica

  // Estado
  isActive  Boolean   @default(true)
  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  createdBy Int?

  // Relaciones
  sede           Sede          @relation(fields: [sedeId], references: [id], onDelete: Cascade)
  subsede        Subsede       @relation(fields: [subsedeId], references: [id], onDelete: Cascade)
  departamento   Departamento? @relation(fields: [departamentoId], references: [id])
  departamentoId Int?

  @@unique([subsedeId, codigo]) // Código único por municipio
  @@index([sedeId])
  @@index([subsedeId])
  @@index([isActive])
  @@index([deletedAt])
  @@map("multas")
}

// ============================================
// MÓDULO DE PERMISOS CIUDADANOS
// ============================================

// Tipos de Permisos (Catálogo/Plantilla por municipio)
model TipoPermiso {
  id        Int @id @default(autoincrement())
  sedeId    Int // Multi-tenant: Estado
  subsedeId Int // Municipio que crea el tipo

  nombre      String  @db.VarChar(100) // "Construcción", "Venta Ambulante"
  descripcion String? @db.Text

  // Configuración de campos personalizados (JSONB)
  camposPersonalizados Json? // Define qué campos adicionales tiene este tipo

  // Costos base (pueden ser sobreescritos por el permiso individual)
  costoBase       Decimal? @db.Decimal(10, 2)
  numUMAsBase     Decimal? @db.Decimal(10, 2)
  numSalariosBase Decimal? @db.Decimal(10, 2)

  // Vigencia por defecto (en días)
  vigenciaDefecto Int @default(365) // 1 año por defecto

  // Estado y auditoría
  isActive  Boolean   @default(true)
  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  createdBy Int?

  // Relaciones
  sede     Sede      @relation(fields: [sedeId], references: [id], onDelete: Cascade)
  subsede  Subsede   @relation(fields: [subsedeId], references: [id], onDelete: Cascade)
  permisos Permiso[]

  @@unique([subsedeId, nombre]) // Nombre único por municipio
  @@index([sedeId])
  @@index([subsedeId])
  @@index([isActive])
  @@index([deletedAt])
  @@map("tipos_permisos")
}

// Permisos Ciudadanos (Solicitudes/Instancias reales)
model Permiso {
  id        Int @id @default(autoincrement())
  sedeId    Int // Multi-tenant: Estado
  subsedeId Int // Municipio

  tipoPermisoId Int // FK a TipoPermiso

  // Folio único
  folio       String  @db.VarChar(50) // Folio único por municipio
  descripcion String? @db.Text

  // Datos del ciudadano solicitante
  nombreCiudadano    String  @db.VarChar(200)
  documentoCiudadano String  @db.VarChar(50) // CURP, RFC, INE, etc.
  domicilioCiudadano String? @db.VarChar(255)
  telefonoCiudadano  String? @db.VarChar(20)
  emailCiudadano     String? @db.VarChar(100)

  // Costos aplicados (copiados del tipo o personalizados al crear)
  costo       Decimal? @db.Decimal(10, 2)
  numSalarios Decimal? @db.Decimal(10, 2)
  numUMAs     Decimal? @db.Decimal(10, 2)

  // Vigencia
  fechaEmision     DateTime
  fechaVencimiento DateTime
  vigenciaDias     Int // Calculado: fechaVencimiento - fechaEmision

  // QR para validación del permiso
  qr String? @db.Text

  // Estado del permiso
  estatus PermisoEstatus @default(SOLICITADO)

  // Documentos adjuntos (array de URLs o paths)
  documentosAdjuntos Json? // [{ "nombre": "Plano.pdf", "url": "..." }]

  // CAMPOS PERSONALIZADOS (JSONB DINÁMICO)
  camposAdicionales Json? // Aquí van los valores de los campos específicos del tipo

  // Fechas importantes del flujo
  fechaSolicitud  DateTime  @default(now())
  fechaAprobacion DateTime?
  fechaRechazo    DateTime?

  // Observaciones y motivos
  observaciones String? @db.Text
  motivoRechazo String? @db.Text

  // Estado y auditoría
  isActive  Boolean   @default(true)
  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  createdBy Int?

  // Relaciones
  sede        Sede        @relation(fields: [sedeId], references: [id], onDelete: Cascade)
  subsede     Subsede     @relation(fields: [subsedeId], references: [id], onDelete: Cascade)
  tipoPermiso TipoPermiso @relation(fields: [tipoPermisoId], references: [id], onDelete: Restrict)
  pagos       PagoPermiso[]

  @@unique([subsedeId, folio]) // Folio único por municipio
  @@index([sedeId])
  @@index([subsedeId])
  @@index([tipoPermisoId])
  @@index([documentoCiudadano]) // Búsqueda por documento
  @@index([estatus]) // Filtrar por estado
  @@index([fechaVencimiento]) // Búsqueda de vencidos
  @@index([isActive])
  @@index([deletedAt])
  @@map("permisos")
}

// Estados del permiso
enum PermisoEstatus {
  SOLICITADO // Recién solicitado
  EN_REVISION // En proceso de revisión
  APROBADO // Aprobado y vigente
  RECHAZADO // Rechazado por autoridad
  VENCIDO // Ya venció la vigencia
  CANCELADO // Cancelado por autoridad o ciudadano

  @@map("permiso_estatus")
}

// ============================================
// MÓDULO DE AGENTES Y PATRULLAS
// ============================================

// Tipos de Agentes (Catálogo)
model TipoAgente {
  id        Int @id @default(autoincrement())
  sedeId    Int // Multi-tenant: Estado
  subsedeId Int // Municipio que crea el tipo

  tipo String @db.VarChar(100)

  // Estado y auditoría
  isActive  Boolean   @default(true)
  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  createdBy Int?

  // Relaciones
  sede    Sede     @relation(fields: [sedeId], references: [id], onDelete: Cascade)
  subsede Subsede  @relation(fields: [subsedeId], references: [id], onDelete: Cascade)
  agentes Agente[]

  @@unique([subsedeId, tipo]) // Tipo único por municipio
  @@index([sedeId])
  @@index([subsedeId])
  @@index([isActive])
  @@index([deletedAt])
  @@map("tipos_agentes")
}

// Agentes
model Patrulla {
  id        Int @id @default(autoincrement())
  sedeId    Int
  subsedeId Int

  marca       String  @db.VarChar(50)
  modelo      String  @db.VarChar(50)
  placa       String  @db.VarChar(20)
  numPatrulla String  @db.VarChar(50)
  serie       String? @db.VarChar(100)

  // Estado y auditoría
  isActive  Boolean   @default(true)
  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  createdBy Int?

  // Relaciones
  sede    Sede     @relation(fields: [sedeId], references: [id], onDelete: Cascade)
  subsede Subsede  @relation(fields: [subsedeId], references: [id], onDelete: Cascade)
  agentes Agente[] // UNA patrulla TIENE VARIOS agentes

  @@unique([subsedeId, numPatrulla])
  @@unique([placa])
  @@index([sedeId])
  @@index([subsedeId])
  @@index([isActive])
  @@index([deletedAt])
  @@map("patrullas")
}

model Agente {
  id        Int @id @default(autoincrement())
  sedeId    Int
  subsedeId Int

  nombres               String  @db.VarChar(100)
  apellidoPaterno       String  @db.VarChar(100)
  apellidoMaterno       String  @db.VarChar(100)
  tipoId                Int
  cargo                 String  @db.VarChar(100)
  numPlantilla          String  @db.VarChar(50)
  numEmpleadoBiometrico String? @db.VarChar(50)
  foto                  String? @db.Text
  whatsapp              String? @db.VarChar(20)
  correo                String? @db.VarChar(100)
  contrasena            String? @db.VarChar(255)
  departamentoId        Int?
  patrullaId            Int? // FK - Un agente está asignado a UNA patrulla

  // Estado y auditoría
  isActive  Boolean   @default(true)
  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  createdBy Int?

  // Relaciones
  sede         Sede          @relation(fields: [sedeId], references: [id], onDelete: Cascade)
  subsede      Subsede       @relation(fields: [subsedeId], references: [id], onDelete: Cascade)
  tipo         TipoAgente    @relation(fields: [tipoId], references: [id])
  departamento Departamento? @relation(fields: [departamentoId], references: [id])
  patrulla     Patrulla?     @relation(fields: [patrullaId], references: [id]) // Agente PERTENECE a una patrulla

  @@unique([subsedeId, numPlantilla])
  @@index([sedeId])
  @@index([subsedeId])
  @@index([tipoId])
  @@index([departamentoId])
  @@index([patrullaId]) // Agregar índice
  @@index([isActive])
  @@index([deletedAt])
  @@map("agentes")
}

// ============================================
// CATÁLOGOS
// ============================================

model Departamento {
  id        Int @id @default(autoincrement())
  sedeId    Int // Multi-tenant: Estado
  subsedeId Int // Municipio que crea el departamento

  nombre      String  @db.VarChar(100)
  descripcion String? @db.VarChar(255)

  // Estado
  isActive  Boolean   @default(true)
  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  createdBy Int?

  // Relaciones
  sede    Sede     @relation(fields: [sedeId], references: [id], onDelete: Cascade)
  subsede Subsede  @relation(fields: [subsedeId], references: [id], onDelete: Cascade)
  multas  Multa[] // Relación con multas
  agentes Agente[]

  @@unique([subsedeId, nombre]) // Nombre único por municipio
  @@index([sedeId])
  @@index([subsedeId])
  @@index([isActive])
  @@index([deletedAt])
  @@map("departamentos")
}

// ============================================
// SISTEMA DE ROLES Y PERMISOS (RBAC)
// ============================================

model UserRole {
  id     Int @id @default(autoincrement())
  userId Int
  roleId Int

  // Relaciones
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  // Auditoría
  assignedAt DateTime @default(now())
  assignedBy Int // ID del usuario que asignó el rol
  isActive   Boolean  @default(true)

  @@unique([userId, roleId])
  @@index([userId])
  @@index([roleId])
  @@map("user_roles")
}

model Role {
  id          Int     @id @default(autoincrement())
  name        String  @unique @db.VarChar(50)
  description String? @db.VarChar(255)
  isActive    Boolean @default(true)

  // Nivel de rol (para jerarquía)
  level RoleLevel @default(MUNICIPAL)

  // Auditoría
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  userRoles   UserRole[]
  permissions RolePermission[]

  @@index([isActive])
  @@index([level])
  @@map("roles")
}

model RolePermission {
  id           Int @id @default(autoincrement())
  roleId       Int
  permissionId Int

  // Relaciones
  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  // Auditoría
  grantedAt DateTime @default(now())
  grantedBy Int // ID del usuario que otorgó el permiso

  @@unique([roleId, permissionId])
  @@index([roleId])
  @@index([permissionId])
  @@map("role_permissions")
}

model Permission {
  id          Int     @id @default(autoincrement())
  resource    String  @db.VarChar(50) // Ej: fines, citizens, reports, settings
  action      String  @db.VarChar(50) // Ej: create, read, update, delete, approve
  description String? @db.VarChar(255)
  isActive    Boolean @default(true)

  // Auditoría
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  roles RolePermission[]

  @@unique([resource, action])
  @@index([isActive])
  @@map("permissions")
}

// ============================================
// ENUMS
// ============================================

enum DocumentType {
  CURP // CURP (México)
  RFC // RFC (México)
  INE // INE/IFE (México)
  PASSPORT // Pasaporte
  VISA // Visa

  @@map("document_type")
}

enum RoleLevel {
  SUPER_ADMIN // Administrador del sistema completo
  ESTATAL // Administrador estatal (Sede)
  MUNICIPAL // Administrador municipal (Subsede)
  OPERATIVO // Usuario operativo

  @@map("role_level")
}

enum AccessLevel {
  SEDE // Acceso a TODO la sede (todos los municipios)
  SUBSEDE // Acceso a UNA o VARIAS subsedes (municipios específicos)

  @@map("access_level")
}

// ============================================
// MÓDULO DE PAGOS DE PERMISOS
// ============================================

model PagoPermiso {
  id        Int @id @default(autoincrement())
  sedeId    Int // Multi-tenant: Estado
  subsedeId Int // Municipio donde se realiza el pago

  // Relación con el permiso pagado
  permisoId Int // FK a Permiso

  // Información del ciudadano (copiada del permiso para histórico)
  nombreCiudadano    String @db.VarChar(200)
  documentoCiudadano String @db.VarChar(50)

  // Costos y cálculos
  costoBase      Decimal @db.Decimal(10, 2) // Costo original del permiso
  descuentoPct   Decimal @default(0) @db.Decimal(5, 2) // Porcentaje de descuento (0-100)
  descuentoMonto Decimal @default(0) @db.Decimal(10, 2) // Monto del descuento en pesos
  total          Decimal @db.Decimal(10, 2) // Total a pagar (costoBase - descuentoMonto)

  // Método de pago
  metodoPago MetodoPago @default(EFECTIVO)

  // Referencia de pago (para transferencias/tarjetas)
  referenciaPago String? @db.VarChar(100)

  // Autorización del descuento
  autorizaDescuento Boolean @default(false)
  autorizadoPor     Int? // FK a User (quien autorizó el descuento)
  firmaAutorizacion String? @db.Text // Firma digital o sello

  // Usuario que registró el pago (cajero/operador)
  usuarioCobroId Int // FK a User

  // Fechas
  fechaPago DateTime @default(now()) // Fecha en que se realizó el pago

  // Estado del pago
  estatus EstatusPago @default(PAGADO)

  // Notas adicionales
  observaciones String? @db.Text

  // Comprobante de pago
  qrComprobante  String? @db.Text // QR code del comprobante

  // Enlaces públicos temporales para compartir comprobante
  tokenPublico   String?   @unique @db.VarChar(255) // Token único para enlace público
  tokenExpiraEn  DateTime? // Fecha de expiración del token

  // REEMBOLSOS: Si este pago es un reembolso, referencia al pago original
  pagoOriginalId Int? // FK a PagoPermiso (self-relation)
  esReembolso    Boolean @default(false) // Flag para identificar reembolsos

  // Auditoría completa
  isActive  Boolean   @default(true)
  deletedAt DateTime? // Soft delete
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  createdBy Int? // Usuario que creó el registro
  updatedBy Int? // Usuario que actualizó el registro
  deletedBy Int? // Usuario que eliminó el registro

  // Relaciones
  sede            Sede         @relation(fields: [sedeId], references: [id], onDelete: Cascade)
  subsede         Subsede      @relation(fields: [subsedeId], references: [id], onDelete: Cascade)
  permiso         Permiso      @relation(fields: [permisoId], references: [id], onDelete: Restrict)
  usuarioCobro    User         @relation("PagosRealizados", fields: [usuarioCobroId], references: [id])
  usuarioAutorizo User?        @relation("PagosAutorizados", fields: [autorizadoPor], references: [id])
  pagoOriginal    PagoPermiso? @relation("ReembolsoPago", fields: [pagoOriginalId], references: [id], onDelete: SetNull)
  reembolsos      PagoPermiso[] @relation("ReembolsoPago") // Pagos que reembolsan este pago

  @@index([sedeId])
  @@index([subsedeId])
  @@index([permisoId])
  @@index([usuarioCobroId])
  @@index([autorizadoPor])
  @@index([fechaPago])
  @@index([estatus])
  @@index([esReembolso])
  @@index([pagoOriginalId])
  @@index([tokenPublico])
  @@index([tokenExpiraEn])
  @@index([isActive])
  @@index([deletedAt])
  @@map("pagos_permisos")
}

// Métodos de pago disponibles
enum MetodoPago {
  EFECTIVO
  TARJETA_DEBITO
  TARJETA_CREDITO
  TRANSFERENCIA
  CHEQUE
  SPEI
  OTRO

  @@map("metodo_pago")
}

// Estados posibles de un pago
enum EstatusPago {
  PAGADO // Pago completado exitosamente
  PENDIENTE // Pago pendiente de confirmar
  CANCELADO // Pago cancelado
  REEMBOLSADO // Pago que fue reembolsado

  @@map("estatus_pago")
}
